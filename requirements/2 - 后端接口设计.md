# AI 文档阅读助手 前端需求驱动的后端接口设计文档（提案 v0.1）

本文基于当前 frontend 代码（组件、store、apiClient）梳理所需后端 API。目标：支撑知识库管理、文档导入、查询对话、进度与任务跟踪、设置管理。后端建议统一前缀：`/api/v1`（现有前端已用 `/api/...`，后续可通过网关 / 版本别名兼容）。

---

## 1. 资源与域模型

| 资源 | 描述 | 主键 |
|------|------|------|
| Collection | 文档集合 + 向量索引封装 | collection_id (slug) |
| Document | 一个 URL 处理后的文档，或者上传的本地文档 | document_id (UUID) |
| Task | 异步任务。目前就只有往数据库加入文档一个尝试任务 | task_id |
| Chat | 代表一个对话对象，维护对话名称、与那些资源库关联等 | chat_id |
| Chat Message | 代表对话中的某条消息 | message_id |
| Settings | 模型/路径等运行配置 | key |

---

## 2. 命名与风格约定

- URL 统一小写、使用复数资源名：`/collections/{id}/documents`
- JSON 字段采用 `snake_case`（与 Python Pydantic 对齐）。前端 TypeScript 层可适配 camelCase。
- 无论正确还是错误，都采用统一的响应结果：
```json
{
  "code": "Success", # 业务 code，成功时都是 Success，失败时就是各种代表失败的 code
  "message": "", # 消息详情。成功时就是空字符串，失败时就是详细的错误消息
  "data": {} # 只有成功时返回，就是最终的数据
}
```

---

## 3. 认证与安全（本地优先）

初期可免认证（仅监听 127.0.0.1）。预留可选 Header：`X-API-Key`。文件系统访问需白名单根目录配置（防止任意路径读取）。

---

## 4. 端点列表概览

| 分类 | 方法 | 路径 | 用途 |
|------|------|------|------|
| 健康 | GET | /api/health | 运行状态 |
| 知识库 | GET | /api/collections | 列出知识库（支持 search） |
| 知识库 | POST | /api/collections | 创建知识库 |
| 知识库 | GET | /api/collections/{collection_id} | 知识库详情/统计 |
| 知识库 | PATCH | /api/collections/{collection_id} | 更新名称/描述 |
| 知识库 | DELETE | /api/collections/{collection_id} | 删除知识库 |
| 文档 | GET | /api/collections/{cid}/documents | 列出文档（分页/搜索） |
| 文档 | GET | /api/collections/{cid}/documents/{doc_id}/download | 下载原文件 |
| 文档 | DELETE | /api/collections/{cid}/documents/{doc_id} | 删除文档 |
| 导入 | POST | /api/collections/{cid}/ingest/folder | 本地文件/文件夹导入（文件路径由前端传入） |
| 导入 | POST | /api/collections/{cid}/ingest/urls | URL 批量抓取与处理 |
| 任务 | GET | /api/tasks/{task_id} | 查询任务状态与统计 |
| 任务（SSE） | GET | /api/tasks/{task_id}/stream | 任务进度/日志流式事件 |
| 聊天 | POST | /api/chats/{chat_id}/chat | 同步问答（返回完整答案） |
| 聊天（SSE） | POST | /api/chats/{chat_id}/chat/stream | 流式问答（metadata/progress/content/sources/done） |
| 对话管理 | GET | /api/chats | 列出对话 |
| 对话管理 | POST | /api/chats | 创建对话 |
| 对话管理 | PATCH | /api/chats/{chat_id} | 重命名/更新关联知识库 |
| 对话管理 | DELETE | /api/chats/{chat_id} | 删除对话 |
| 对话管理 | GET | /api/chats/{chat_id}/messages | 拉取对话消息列表 |
| 设置 | GET | /api/settings | 获取设置（敏感字段掩码） |
| 设置 | PATCH | /api/settings | 更新设置（LLM/Embedding/数据目录） |

---

## 5. 详细接口设计

### 5.1 健康

GET /api/health  
响应：
```json
{
  "status": "ok",
  "version": "0.1.0",
  "embeddings_available": true
}
```

### 5.2 知识库 Collections

#### 创建
POST /api/collections
```json
{
  "id": "product_manual",
  "name": "产品手册",
  "description": "V1.0 用户文档"
}
```
响应 201：
```json
{
  "id": "product_manual",
  "name": "产品手册",
  "description": "V1.0 用户文档",
  "document_count": 0,
  "vector_count": 0,
  "created_at": "2025-08-13T10:12:00Z",
  "updated_at": "2025-08-13T11:20:00Z"
}
```

#### 列表

> 暂时不需要做分页

GET /api/collections?search=关键字  
响应：

```json
{
  "collections": [
    {
      "id": "product_manual",
      "name": "产品手册",
      "description": "V1.0 用户文档",
      "document_count": 12,
      "vector_count": 4380,
      "created_at": "2025-08-13T10:12:00Z",
      "updated_at": "2025-08-13T11:20:00Z"
    }
  ],
  "total": 1
}
```

#### 详情
GET /api/collections/{collection_id}  
增加统计：

```json
{
  "id": "product_manual",
  "name": "产品手册",
  "description": "V1.0 用户文档",
  "document_count": 12,
  "vector_count": 4380,
  "created_at": "...",
  "updated_at": "..."
}
```

#### 更新 / 删除
PATCH /api/collections/{collection_id}  
```json
请求 body: { "name": "产品手册V1", "description": "更新说明" }
响应 body 为 空
```
DELETE /api/collections/{collection_id}
```json
删除成功直接响应 200
```

### 5.3 文档 Documents

#### 列表
GET /api/collections/{cid}/documents?page=1&page_size=50&search=pdf  
响应：

```json
{
  "documents": [
    {
      "id": "doc_1",
      "name": "user_guide.pdf",
      "uri": "file:///abs/path/user_guide.pdf", // 如果是本地文件就是 file://xxx 如果是链接就是 https://xxx
      "size_bytes": 2104320,
      "mime_type": "application/pdf",
      "chunk_count": 180,
      "status": "indexed",
      "created_at": "...",
      "updated_at": "..."
    }
  ],
  "page": 1,
  "page_size": 50,
  "total": 3
}
```

#### 下载
GET /api/collections/{cid}/documents/{doc_id}/download  
Headers: `Content-Disposition: attachment; filename="user_guide.pdf"`

#### 删除
DELETE /api/collections/{cid}/documents/{doc_id} -> 200  
```json
{ "document_id": "doc_1", "deleted": true }
```

### 5.4 导入 / 抓取（异步）

统一响应：
```json
{ "task_id": "task_ingest_123", "status": "pending" }
```

#### 本地文件上传
POST /api/collections/{cid}/ingest/folder  
```json
{
  "files": ["/Users/zouguodong/zxxx/dwe.md", "/Users/zouguodong/zxxx/dwe.md"] // 文件或者文件夹选择阶段完全由前端搞定。选择文件夹后先提示用户会上传哪些文件，然后再调用接口
}
```

#### URL 爬取
POST /api/collections/{cid}/ingest/urls
```json
{
  "urls": ["https://example.com/faq","https://example.com/api"],
  "max_depth": 2, // 递归爬取深度，只会递归爬取与目标 URL 同域名下的文档。否则就无穷无尽了
  "override": true, // 遇到重复的 url 是否重新爬取并处理
}
```

### 5.5 任务 & 进度

> 这是比较核心的一部分

GET /api/tasks/{task_id}  
```json
{
  "task_id": "task_ingest_123",
  "type": "ingest_files",
  "status": "processing",
  "progress": {"percentage": 20},
  "stats": {"files_processed": 12, "files_total": 60},
  "collection_id": "product_manual",
  "created_at": "...",
  "updated_at": "...",
  "error": null
}
```

SSE: GET /api/tasks/{task_id}/stream  
事件（event 字段可选，data 为 JSON）：
- progress
```json
{"event":"progress","data":{"percentage": 20, "stats": {"files_processed": 12, "files_total": 60}}}
```
- log
```json
{"event":"log","data":{"level":"info","message":"Parsed PDF: user_guide.pdf"}}
```
- error
```json
{"event":"error","data":{message":"Timeout"}}
```
- done
```json
{"event":"done","data":{"chunks_indexed":1800,"duration_ms":12345}}
```

#### 任务流式事件

| 领域      | 事件类型 | 说明       |
| --------- | -------- | ---------- |
| 查询      | metadata | 初始上下文 |
| 查询/任务 | progress | 进度条     |
| 查询/任务 | error    | 错误终止   |
| 查询/任务 | done     | 完成标志   |
| 任务      | log      | 详细日志行 |

#### 任务类型

- ingest_files：处理本地文件导入
- ingest_urls：处理 URL 抓取和导入

#### 任务状态机

即任务的 status 字段

- pending: 待启动
- processing: 运行中
- success: 成功
- failed: 失败

### 5.6 对话

对话主要有两个关键实体概念

- chat：对应一个数据库实体
- message：对应一个数据库实体

#### 聊天
POST /api/chats/{chat_id}/chat
```json
{
  "content": "安装步骤？",
  "include_sources": true, // 回答的消息是否包含引用（在聊天框下方有个单选框用于标记）
}
```
响应：
```json
{
  "message_id": "message_id1",
  "content": "安装包含三步：...",
  "sources": [
    {
      "file_name": "user_guide.pdf",
      "line_number": 12
    }
  ]
}
```

#### 流式
POST /api/chats/{chat_id}/chat/stream  (Accept: text/event-stream)

```json 
{
  "content": "安装步骤？",
  "include_sources": true, // 回答的消息是否包含引用（在聊天框下方有个单选框用于标记）
}
```


响应事件协议：

1. metadata 首先会在数据库创建一个空的消息，生成一个消息 id 并传递给客户端
```json
{"type":"metadata", "message_id": "message_id1"}
```
2. content（多次）

```json
{"type":"content","content":"安装包含"}
{"type":"content","content":" 三个主要步骤："}
```
3. sources（一次或更新）

```json
{"type":"sources","sources":[{"file_name": "user_guide.pdf", "line_number": 12}]}
```
4. done

```json
{"type":"done"}
```
5. error

```json
{"type":"error","error":"Embedding service unavailable"}
```

#### 聊天事件流约定

| 事件类型 | 说明            | 必备字段   |
| -------- | --------------- | ---------- |
| metadata | 响应元信息说明  | message_id |
| content  | 生成 token/片段 | content    |
| sources  | 最终或增量引用  | sources[]  |
| error    | 错误终止        | error      |
| done     | 完成事件        |            |

#### 对话管理

> 包含对话本身的增删改查

GET /api/chats

响应:

```json
{
  "chats": [
    {
        "chat_id": "chat_123",
        "name": "安装问题排查",
        "collection_ids": ["product_manual"],
        "message_count": 0,
        "created_at": "...",
        "last_message_at": null
    }
  ],
  "total": 3
}
```

POST /api/chats
```json
{
  "name": "安装问题排查",
  "collection_ids": ["product_manual"],
  "initial_question": "如何安装？"
}
```
响应：
```json
{
  "id": "chat_123",
  "name": "安装问题排查",
  "collection_ids": ["product_manual"],
  "message_count": 0,
  "created_at": "...",
  "last_message_at": null
}
```

PATCH /api/chats/{chat_id}

```json
{
  "name": "安装问题排查",
  "collection_ids": ["product_manual"],
  "initial_question": "如何安装？"
}
```

响应

```json
{
  "id": "chat_123",
  "name": "安装问题排查",
  "collection_ids": ["product_manual"],
  "message_count": 0,
  "created_at": "...",
  "last_message_at": null
}
```

DELETE /api/chats/{chat_id}

响应

```json
{
  "id": "chat_123",
  "name": "安装问题排查",
  "collection_ids": ["product_manual"],
  "message_count": 0,
  "created_at": "...",
  "last_message_at": null
}
```



拉取消息：
GET /api/chats/{chat_id}/messages  
响应

```json
{
  "messages": {
    
  },
  "total": 12
}
```

### 5.7 设置

GET /api/settings  
响应（敏感字段掩码）：
```json
{
  "llm": { "base_url": "https://api.openai.com/v1", "chat_model": "gpt-4o", "api_key_masked": true },
  "embedding": { "base_url": "...", "embedding_model": "text-embedding-3-small", "api_key_masked": true },
  "data_location": "/Users/me/data"
}
```

PATCH /api/settings  
```json
{
  "llm": { "chat_model": "gpt-4o-mini" },
  "embedding": { "embedding_model": "text-embedding-3-large" },
  "data_location": "/new/path"
}
```

---

## 6. 渐进式落地优先级

1. 现有端点规范化：collections CRUD + query 多库化 + streaming 事件补全  
2. 文档列出 / 删除 / 下载  
3. 文件 & URL 导入（任务 + SSE）  
4. 爬虫统一任务化  
5. Chat 会话 / 历史持久化  
6. 设置 API  
7. 高级：多策略检索（BM25 + 语义）、缓存层、RAG 评估指标

