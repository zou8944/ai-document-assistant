# AI 文档阅读助手 - SQLite 数据库设计文档（简化版）

基于[后端接口设计文档](./2%20-%20后端接口设计.md)的资源模型，设计 SQLite 数据库架构。

---

## 1. 数据库设计原则

- **本地优先**：使用 SQLite 作为嵌入式数据库，无需额外服务
- **ACID 保证**：利用 SQLite 事务机制确保数据一致性
- **性能优化**：合理使用索引，支持全文搜索
- **可扩展性**：预留字段和表结构，支持功能扩展
- **数据完整性**：外键约束和检查约束保证数据质量

---

## 2. 核心表设计

### 2.1 集合表 (collections)

知识库集合，对应向量数据库中的 collection。

```sql
CREATE TABLE collections (
    id TEXT PRIMARY KEY,              -- collection_id (slug)
    name TEXT NOT NULL,               -- 显示名称
    description TEXT DEFAULT '',     -- 描述信息
    document_count INTEGER DEFAULT 0, -- 文档数量（冗余字段，便于统计）
    vector_count INTEGER DEFAULT 0,   -- 向量数量（冗余字段）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    -- 约束
    CONSTRAINT chk_id_format CHECK (id REGEXP '^[a-zA-Z0-9_-]+$'),
    CONSTRAINT chk_name_length CHECK (LENGTH(name) BETWEEN 1 AND 200)
);

-- 索引
CREATE INDEX idx_collections_name ON collections(name);
CREATE INDEX idx_collections_updated_at ON collections(updated_at DESC);
```

### 2.2 文档表 (documents)

单个文档记录，可能来源于本地文件或 URL 抓取。

```sql
CREATE TABLE documents (
    id TEXT PRIMARY KEY DEFAULT (hex(randomblob(16))), -- UUID
    collection_id TEXT NOT NULL,
    name TEXT NOT NULL,               -- 文件名或页面标题
    uri TEXT NOT NULL,                -- file:// 或 https:// 格式的 URI
    size_bytes INTEGER DEFAULT 0,    -- 文件大小
    mime_type TEXT,                   -- MIME 类型
    chunk_count INTEGER DEFAULT 0,    -- 分块数量（冗余字段）
    status TEXT DEFAULT 'pending',    -- pending, processing, indexed, failed
    error_message TEXT,               -- 处理错误信息
    hash_md5 TEXT,                    -- 文件 MD5 哈希（去重）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    
    -- 检查约束
    CONSTRAINT chk_status CHECK (status IN ('pending', 'processing', 'indexed', 'failed')),
    CONSTRAINT chk_uri_format CHECK (uri LIKE 'file://%' OR uri LIKE 'http://%' OR uri LIKE 'https://%'),
    CONSTRAINT chk_size CHECK (size_bytes >= 0)
);

-- 索引
CREATE INDEX idx_documents_collection_id ON documents(collection_id);
CREATE INDEX idx_documents_status ON documents(status);
CREATE INDEX idx_documents_hash ON documents(hash_md5);
CREATE INDEX idx_documents_updated_at ON documents(updated_at DESC);
CREATE UNIQUE INDEX idx_documents_uri_collection ON documents(collection_id, uri); -- 避免重复导入
```

### 2.3 任务表 (tasks)

任务表是一个相对中性的表，与业务关系比较大的就放在 input_params 和 stats 中。

比如对于 url 抓取任务，input_params就存储初始的 urls 和是否递归抓取；stats 就存储当前已经处理了多少个文件，还有多少个文件需要处理

```sql
CREATE TABLE tasks (
    id TEXT PRIMARY KEY DEFAULT ('task_' || hex(randomblob(8))), -- task_xxx
    type TEXT NOT NULL,               -- ingest_files ingest_urls
    status TEXT DEFAULT 'pending',    -- pending, processing, success, failed
    collection_id TEXT,               -- 关联的集合 ID
  	progress_percentage INTEGER DEFAULT 0, -- 进度
    
    -- 输入参数
    input_params JSON DEFAULT '{}',   -- 任务输入参数（JSON）
    -- 统计信息
    stats JSON DEFAULT '{}',          -- 统计数据（JSON）
    
    -- 错误信息
    error_message TEXT,               -- 错误详情
    
    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    started_at DATETIME,              -- 开始执行时间
    completed_at DATETIME,            -- 完成时间
    
    -- 检查约束
    CONSTRAINT chk_task_type CHECK (type IN ('ingest_files', 'ingest_urls')),
    CONSTRAINT chk_task_status CHECK (status IN ('pending', 'processing', 'success', 'failed')),
    CONSTRAINT chk_progress CHECK (progress_percentage BETWEEN 0 AND 100)
);

-- 索引
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_collection_id ON tasks(collection_id);
CREATE INDEX idx_tasks_created_at ON tasks(created_at DESC);
CREATE INDEX idx_tasks_type_status ON tasks(type, status);
```

### 2.4 对话表 (chats)

对话会话管理。

```sql
CREATE TABLE chats (
    id TEXT PRIMARY KEY DEFAULT ('chat_' || hex(randomblob(8))), -- chat_xxx
    name TEXT NOT NULL,               -- 对话名称
    collection_ids JSON DEFAULT '[]', -- 关联的集合 ID 列表（JSON 数组）
    message_count INTEGER DEFAULT 0,  -- 消息数量（冗余字段）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_message_at DATETIME,         -- 最后一条消息时间
    
    -- 约束
    CONSTRAINT chk_name_length CHECK (LENGTH(name) BETWEEN 1 AND 200)
);

-- 索引
CREATE INDEX idx_chats_updated_at ON chats(updated_at DESC);
CREATE INDEX idx_chats_last_message_at ON chats(last_message_at DESC);
```

### 2.5 消息表 (chat_messages)

对话中的具体消息记录。

```sql
CREATE TABLE chat_messages (
    id TEXT PRIMARY KEY DEFAULT ('msg_' || hex(randomblob(8))), -- msg_xxx
    chat_id TEXT NOT NULL,
    role TEXT NOT NULL,               -- user, assistant
    content TEXT NOT NULL,            -- 消息内容
    sources JSON DEFAULT '[]',        -- 引用来源（JSON 数组）
    metadata JSON DEFAULT '{}',       -- 额外元数据（模型参数等）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    -- 检查约束
    CONSTRAINT chk_role CHECK (role IN ('user', 'assistant')),
    CONSTRAINT chk_content_length CHECK (LENGTH(content) > 0)
);

-- 索引
CREATE INDEX idx_chat_messages_chat_id ON chat_messages(chat_id);
```

### 2.6 设置表 (settings)

系统配置管理。

```sql
CREATE TABLE settings (
    key TEXT PRIMARY KEY,             -- 设置键名
    value TEXT NOT NULL,              -- 设置值（JSON 或字符串）
    value_type TEXT DEFAULT 'string', -- string, json, number, boolean
    category TEXT DEFAULT 'general',  -- general, llm, embedding, paths
    description TEXT DEFAULT '',      -- 设置说明
    is_sensitive BOOLEAN DEFAULT FALSE, -- 是否敏感信息（API 密钥等）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    -- 检查约束
    CONSTRAINT chk_value_type CHECK (value_type IN ('string', 'json', 'number', 'boolean')),
    CONSTRAINT chk_category CHECK (category IN ('general', 'llm', 'embedding', 'paths', 'crawler'))
);

-- 索引
CREATE INDEX idx_settings_category ON settings(category);
CREATE INDEX idx_settings_sensitive ON settings(is_sensitive);
```

### 2.7 文档块表 (document_chunks)

文档分块记录，用于精确管理文档与向量数据库的映射关系。

```sql
CREATE TABLE document_chunks (
    id TEXT PRIMARY KEY DEFAULT ('chunk_' || hex(randomblob(8))), -- chunk_xxx
    document_id TEXT NOT NULL,
    collection_id TEXT NOT NULL,      -- 冗余字段，便于快速查询
    chunk_index INTEGER NOT NULL,     -- 在文档中的块序号（从0开始）
    content_preview TEXT,             -- 内容预览（前200字符，用于调试）
    start_char INTEGER,               -- 在原文档中的开始字符位置
    end_char INTEGER,                 -- 在原文档中的结束字符位置
    vector_id TEXT NOT NULL,          -- Chroma 中的向量 ID
    content_hash TEXT,                -- 内容哈希（用于去重和缓存）
    metadata JSON DEFAULT '{}',       -- 额外元数据
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    -- 检查约束
    CONSTRAINT chk_chunk_index CHECK (chunk_index >= 0),
    CONSTRAINT chk_char_positions CHECK (start_char >= 0 AND end_char > start_char),
);

-- 索引
CREATE INDEX idx_chunks_document_id ON document_chunks(document_id);
CREATE INDEX idx_chunks_collection_id ON document_chunks(collection_id);
CREATE INDEX idx_chunks_vector_id ON document_chunks(vector_id);
CREATE INDEX idx_chunks_status ON document_chunks(embedding_status);
CREATE UNIQUE INDEX idx_chunks_doc_index ON document_chunks(document_id, chunk_index);
CREATE UNIQUE INDEX idx_chunks_vector_unique ON document_chunks(vector_id);
```

### 2.8 任务日志表 (task_logs)

任务执行过程中的详细日志。

```sql
CREATE TABLE task_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT NOT NULL,
    level TEXT NOT NULL,              -- debug, info, warning, error
    message TEXT NOT NULL,
    details JSON DEFAULT '{}',        -- 详细信息（JSON）
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    -- 注：不使用外键约束，避免复杂性
    
    -- 检查约束
    CONSTRAINT chk_log_level CHECK (level IN ('debug', 'info', 'warning', 'error'))
);

-- 索引
CREATE INDEX idx_task_logs_task_id ON task_logs(task_id);
CREATE INDEX idx_task_logs_timestamp ON task_logs(timestamp);
CREATE INDEX idx_task_logs_level ON task_logs(level);
```

---

## 3. 触发器设计

### 3.1 自动更新时间戳

```sql
-- 集合表更新时间戳触发器
CREATE TRIGGER tr_collections_updated_at
    AFTER UPDATE ON collections
    FOR EACH ROW
BEGIN
    UPDATE collections SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

-- 文档表更新时间戳触发器
CREATE TRIGGER tr_documents_updated_at
    AFTER UPDATE ON documents
    FOR EACH ROW
BEGIN
    UPDATE documents SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

-- 任务表更新时间戳触发器
CREATE TRIGGER tr_tasks_updated_at
    AFTER UPDATE ON tasks
    FOR EACH ROW
BEGIN
    UPDATE tasks SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

-- 对话表更新时间戳触发器
CREATE TRIGGER tr_chats_updated_at
    AFTER UPDATE ON chats
    FOR EACH ROW
BEGIN
    UPDATE chats SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

-- 设置表更新时间戳触发器
CREATE TRIGGER tr_settings_updated_at
    AFTER UPDATE ON settings
    FOR EACH ROW
BEGIN
    UPDATE settings SET updated_at = CURRENT_TIMESTAMP WHERE key = NEW.key;
END;
```

---

## 4. 初始数据

### 4.1 默认设置

```sql
INSERT INTO settings (key, value, value_type, category, description, is_sensitive) VALUES
-- LLM 设置
('llm.base_url', 'https://api.openai.com/v1', 'string', 'llm', 'LLM API 基础 URL', false),
('llm.chat_model', 'gpt-4o', 'string', 'llm', '聊天模型名称', false),
('llm.api_key', '', 'string', 'llm', 'LLM API 密钥', true),
('llm.temperature', '0.1', 'number', 'llm', '模型温度参数', false),
('llm.max_tokens', '2048', 'number', 'llm', '最大输出令牌数', false),

-- Embedding 设置
('embedding.base_url', 'https://api.openai.com/v1', 'string', 'embedding', 'Embedding API 基础 URL', false),
('embedding.model', 'text-embedding-3-small', 'string', 'embedding', 'Embedding 模型名称', false),
('embedding.api_key', '', 'string', 'embedding', 'Embedding API 密钥', true),
('embedding.dimensions', '1536', 'number', 'embedding', 'Embedding 维度', false),

-- 路径设置
('paths.data_location', './data', 'string', 'paths', '数据存储位置', false),
('paths.allowed_roots', '[]', 'json', 'paths', '允许访问的根目录列表', false),

-- 爬虫设置
('crawler.max_concurrent', '5', 'number', 'crawler', '最大并发爬取数', false),
('crawler.delay_seconds', '1.0', 'number', 'crawler', '爬取延迟（秒）', false),
('crawler.timeout_seconds', '30', 'number', 'crawler', '请求超时（秒）', false),
('crawler.user_agent', 'AI-Document-Assistant/1.0', 'string', 'crawler', '爬虫用户代理', false),

-- 文本处理设置
('text.chunk_size', '1000', 'number', 'general', '文本分块大小', false),
('text.chunk_overlap', '200', 'number', 'general', '文本分块重叠', false),
('text.max_file_size_mb', '50', 'number', 'general', '最大文件大小（MB）', false);
```

---

## 5. 数据库优化建议

### 5.1 性能优化

```sql
-- 启用 WAL 模式（提高并发性能）
PRAGMA journal_mode=WAL;

-- 设置合适的缓存大小（例如 64MB）
PRAGMA cache_size=16384;

-- 启用外键约束
PRAGMA foreign_keys=ON;

-- 设置同步模式为 NORMAL（平衡性能和安全性）
PRAGMA synchronous=NORMAL;

-- 优化临时存储
PRAGMA temp_store=MEMORY;
```

---

## 6. 迁移脚本结构

建议创建版本化的迁移脚本：

```
backend/migrations/
├── 001_initial_schema.sql      # 基础表结构（collections, documents, tasks, chats, chat_messages, settings）
├── 002_document_chunks.sql     # 文档块表
├── 003_task_logs.sql          # 任务日志表
├── 004_triggers.sql            # 时间戳更新触发器
├── 005_initial_data.sql       # 初始设置数据
└── migration_runner.py        # 迁移执行器
```

## 7. 向量数据库映射策略

### 7.1 映射关系设计

**SQLite → Chroma 映射**：
```python
# SQLite 记录
document_chunks.vector_id = f"{document_id}_chunk_{chunk_index}"

# Chroma 存储
chroma_collection.add(
    ids=[vector_id],
    embeddings=[embedding_vector],
    metadatas=[{
        "document_id": document_id,
        "collection_id": collection_id, 
        "chunk_index": chunk_index,
        "source": f"{document_name}#chunk_{chunk_index}"
    }]
)
```

### 7.2 数据一致性保证

1. **写入流程**：
   - SQLite 先创建 document_chunks 记录（status='pending'）
   - 向量化完成后写入 Chroma
   - 更新 SQLite 记录（status='indexed'，触发统计更新）

2. **删除流程**：
   - 查询 SQLite 获取 vector_id 列表
   - 批量删除 Chroma 中的向量
   - 删除 SQLite 记录（外键级联删除）

3. **查询流程**：
   - Chroma 检索返回 vector_id 和 metadata
   - SQLite 查询获取完整的 chunk 和 document 信息
   - 组合返回给前端

这个数据库设计支持 API 文档中的所有功能需求，提供了完整的数据模型和约束机制，确保数据一致性和查询性能。通过 document_chunks 表精确管理向量数据库映射关系，支持细粒度的状态跟踪和错误处理。