# AI 文档阅读助手 - 功能实现优先级文档

基于 API 设计文档、数据库设计文档和当前技术栈，制定详细的功能实现计划，按优先级从高到低排序。

---

## 当前技术栈分析

### 🛠️ 已有技术组件
- **数据库**: 将使用 SQLAlchemy ORM + SQLite
- **向量存储**: ChromaDB (已实现 ChromaManager)
- **爬虫**: requests + BeautifulSoup (SimpleWebCrawler，非 Crawl4AI)
- **RAG**: LangChain + OpenAI (已实现 RetrievalChain)
- **LLM**: OpenAI ChatGPT (通过 LangChain)
- **Embedding**: OpenAI text-embedding-ada-002
- **文档处理**: PyPDF, python-docx, markdownify
- **API 框架**: FastAPI + Uvicorn

### 🔧 需要新增的组件
- SQLAlchemy 模型定义和数据库操作
- 异步任务系统 (可使用 asyncio + 队列)
- SSE (Server-Sent Events) 支持
- 统一 API 响应格式

---

## 📊 实施进度状态

**当前阶段**: P0 高优先级任务实施中

| 阶段 | 任务数 | 已完成 | 进度 | 状态 |
|------|--------|--------|------|------|
| P0 高优先级 | 5 | 1 | 20% | 🚧 进行中 |
| P1 中优先级 | 4 | 0 | 0% | ⏳ 待开始 |
| P2 低优先级 | 5 | 0 | 0% | ⏳ 待开始 |

**最近完成**: ✅ P0-1 SQLAlchemy 数据库架构 (2024-08-17)  
**下一步**: P0-2 统一 API 响应框架

---

## 优先级分类说明

- **P0 (高优先级)**: 核心功能，必须先实现，是整个应用的基础
- **P1 (中优先级)**: 重要功能，提升用户体验
- **P2 (低优先级)**: 高级功能，可在基础功能稳定后实现

---

## P0 高优先级任务 (必须优先实现)

### 1. SQLAlchemy 数据库架构 (P0-1)
**预估时间**: 2-3天  
**依赖**: 无  
**描述**: 使用 SQLAlchemy 建立 SQLite 数据库基础，支撑所有后续功能

#### 实现任务:
- [x] 添加 SQLAlchemy 依赖 (`sqlalchemy`, `alembic`)
- [x] 创建 SQLAlchemy 模型 (`backend/models/database/`)
  - [x] Collection 模型 (知识库集合)
  - [x] Document 模型 (文档)
  - [x] DocumentChunk 模型 (文档块)
  - [x] Task 模型 (任务)
  - [x] TaskLog 模型 (任务日志)
  - [x] Chat 模型 (对话)
  - [x] ChatMessage 模型 (消息)
  - [x] Settings 模型 (设置)
- [x] 实现数据库连接和会话管理 (`backend/database/`)
- [x] 创建 Alembic 迁移环境和初始迁移
- [x] 实现基础 CRUD 操作类 (Repository 模式)
- [x] 添加数据库初始化脚本

#### 验收标准:
- ✅ SQLAlchemy 模型符合数据库设计文档
- ✅ 支持 Alembic 数据库迁移
- ✅ 数据库连接和事务管理正常
- ✅ 初始设置数据能正确插入

---

### 2. 统一 API 响应框架 (P0-2)
**预估时间**: 1-2天  
**依赖**: P0-1 SQLAlchemy 数据库架构  
**描述**: 重构现有 FastAPI 架构，建立统一的 API 响应格式

#### 实现任务:
- [x] 重构现有 FastAPI 应用结构
- [x] 实现统一响应格式中间件 (`code`, `message`, `data`)
- [x] 创建全局异常处理器
- [x] 重构健康检查端点 `/api/health` 
- [x] 建立 API 版本管理路由 (`/api/v1/`)
- [x] 集成 SQLAlchemy 会话管理到 FastAPI
- [x] 实现请求/响应日志记录

#### 验收标准:
- 所有 API 响应格式统一 (成功/失败都符合规范)
- 健康检查返回 Embedding 可用性状态
- 全局错误处理机制完善
- SQLAlchemy 事务管理集成到路由中

---

### 3. 知识库管理核心功能 (P0-3)
**预估时间**: 3-4天  
**依赖**: P0-2 统一 API 响应框架  
**描述**: 基于 SQLAlchemy + ChromaDB 实现知识库完整 CRUD

#### 实现任务:
- [ ] 创建 Collection Repository (SQLAlchemy CRUD)
- [ ] 实现知识库 API 端点 (`/api/v1/collections`):
  - `POST /api/v1/collections` - 创建知识库
  - `GET /api/v1/collections` - 列表查询（支持搜索）
  - `GET /api/v1/collections/{id}` - 详情查询
  - `PATCH /api/v1/collections/{id}` - 更新知识库
  - `DELETE /api/v1/collections/{id}` - 删除知识库
- [ ] 集成现有 ChromaManager 到知识库操作
- [ ] 实现知识库统计功能 (document_count, vector_count)
- [ ] 实现删除时同步清理 ChromaDB collection

#### 验收标准:
- 知识库 CRUD 操作符合 API 设计文档
- 正确统计文档和向量数量（查询数据库和 ChromaDB）
- 删除知识库时同步删除 ChromaDB collection
- 支持知识库名称搜索功能

---

### 4. 基础文档管理 (P0-4)
**预估时间**: 2-3天  
**依赖**: P0-3 知识库管理  
**描述**: 基于 SQLAlchemy 实现文档管理，集成现有文件处理

#### 实现任务:
- [ ] 创建 Document Repository (SQLAlchemy CRUD)
- [ ] 实现文档 API 端点:
  - `GET /api/v1/collections/{cid}/documents` - 文档列表（分页，搜索）
  - `DELETE /api/v1/collections/{cid}/documents/{doc_id}` - 删除文档
  - `GET /api/v1/collections/{cid}/documents/{doc_id}/download` - 下载文件
- [ ] 实现文档状态管理 (pending, processing, indexed, failed)
- [ ] 集成现有 file_processor 进行文档元数据提取
- [ ] 实现删除时同步清理 ChromaDB 向量数据

#### 验收标准:
- 文档列表支持分页和搜索
- 文档状态正确跟踪和更新
- 删除文档时同步删除相关向量数据
- 本地文件能正确下载（对于 file:// URI）

---

### 5. 设置管理系统 (P0-5)
**预估时间**: 1-2天  
**依赖**: P0-2 统一 API 响应框架  
**描述**: 基于 SQLAlchemy 实现系统设置管理，兼容现有配置系统

#### 实现任务:
- [ ] 创建 Settings Repository (SQLAlchemy CRUD)
- [ ] 实现设置 API 端点:
  - `GET /api/v1/settings` - 获取设置（敏感字段掩码）
  - `PATCH /api/v1/settings` - 更新设置
- [ ] 实现敏感信息掩码显示逻辑
- [ ] 实现设置分类管理和验证
- [ ] 集成现有 config.py 配置系统
- [ ] 实现动态配置更新机制

#### 验收标准:
- 设置读取和更新符合 API 设计
- 敏感信息（API 密钥）正确掩码显示
- 设置更新能动态生效（更新全局 config）
- 支持设置项类型验证和约束检查

---

## P1 中优先级任务 (核心功能完善)

### 6. 本地文件导入功能 (P1-1)
**预估时间**: 4-5天  
**依赖**: P0-3, P0-4 知识库和文档管理  
**描述**: 集成现有文件处理器，实现本地文件异步导入

#### 实现任务:
- [ ] 创建 Task Repository (SQLAlchemy CRUD)
- [ ] 实现异步任务系统 (asyncio.Queue + 后台 workers)
- [ ] 实现文件导入 API 端点:
  - `POST /api/v1/collections/{cid}/ingest/folder` - 本地文件导入
- [ ] 集成现有 file_processor.py 进行文件处理:
  - 使用现有 PDF/Word/Markdown 处理逻辑
  - 集成现有 text_splitter (LangChain RecursiveCharacterTextSplitter)
- [ ] 实现文档向量化流程：
  - 使用现有 OpenAIEmbeddings
  - 存储到 ChromaDB (现有 ChromaManager)
- [ ] 实现文件去重机制 (MD5 哈希)
- [ ] 实现任务进度追踪和状态更新

#### 验收标准:
- 支持现有文件格式的导入 (PDF, DOCX, MD, TXT)
- 文件能正确切分和向量化存储
- 导入任务异步执行，不阻塞 API
- 支持基于 MD5 的文件去重

---

### 7. 任务系统和进度跟踪 (P1-2)
**预估时间**: 3-4天  
**依赖**: P1-1 文件导入功能  
**描述**: 实现任务管理和 SSE 进度推送

#### 实现任务:
- [ ] 实现任务 API 端点:
  - `GET /api/v1/tasks/{task_id}` - 任务状态查询
  - `GET /api/v1/tasks/{task_id}/stream` - 任务进度 SSE 流
- [ ] 实现任务状态机管理 (pending → processing → success/failed)
- [ ] 实现任务进度计算和更新逻辑
- [ ] 添加 FastAPI SSE (Server-Sent Events) 支持
- [ ] 实现任务日志系统 (可选数据库表或内存)
- [ ] 实现任务错误处理和异常捕获

#### 验收标准:
- 任务状态和进度能正确跟踪
- SSE 能实时推送任务进度事件
- 任务错误能被捕获和记录
- 符合 API 设计的事件格式 (progress/log/error/done)

---

### 8. 基础问答功能 (P1-3)
**预估时间**: 3-4天  
**依赖**: P0-3, P0-5 知识库管理和设置  
**描述**: 集成现有 RAG 实现，实现多知识库问答

#### 实现任务:
- [ ] 创建 Chat/ChatMessage Repository (SQLAlchemy CRUD)
- [ ] 实现问答 API 端点:
  - `POST /api/v1/chats/{chat_id}/chat` - 同步问答
  - `POST /api/v1/chats/{chat_id}/chat/stream` - 流式问答 (SSE)
- [ ] 集成现有 RetrievalChain，支持多知识库检索:
  - 修改检索逻辑支持多个 collection
  - 使用现有 ChromaManager 进行向量检索
- [ ] 集成现有 LLM 配置 (config.py OpenAI 设置)
- [ ] 实现消息历史持久化
- [ ] 实现来源引用格式化

#### 验收标准:
- 能基于多个知识库回答问题
- 支持流式输出 (SSE events: metadata/content/sources/done)
- 正确记录问答历史到数据库
- 提供准确的来源引用信息

---

### 9. 对话管理功能 (P1-4)
**预估时间**: 2-3天  
**依赖**: P1-3 基础问答功能  
**描述**: 基于 SQLAlchemy 实现完整对话管理

#### 实现任务:
- [ ] 实现对话管理 API 端点:
  - `GET /api/v1/chats` - 对话列表
  - `POST /api/v1/chats` - 创建对话
  - `PATCH /api/v1/chats/{chat_id}` - 更新对话
  - `DELETE /api/v1/chats/{chat_id}` - 删除对话
  - `GET /api/v1/chats/{chat_id}/messages` - 消息历史
- [ ] 实现对话与知识库关联 (多对多关系)
- [ ] 实现消息分页查询
- [ ] 实现对话统计 (消息数量，最后消息时间)
- [ ] 实现对话删除时的级联清理

#### 验收标准:
- 对话 CRUD 操作符合 API 设计
- 对话能关联多个知识库
- 消息历史支持分页查询
- 删除对话时正确清理相关消息

---

## P2 低优先级任务 (高级功能)

### 10. URL 抓取功能 (P2-1)
**预估时间**: 5-6天  
**依赖**: P1-1, P1-2 文件导入和任务系统  
**描述**: 集成现有 SimpleWebCrawler，实现网页抓取功能

#### 实现任务:
- [ ] 实现 URL 抓取 API 端点:
  - `POST /api/v1/collections/{cid}/ingest/urls` - URL 批量抓取
- [ ] 集成现有 SimpleWebCrawler (requests + BeautifulSoup)
- [ ] 实现递归爬取任务化 (基于现有 crawl_domain 逻辑)
- [ ] 实现爬取进度跟踪 (集成任务系统)
- [ ] 实现爬取结果存储 (转换为文档并向量化)
- [ ] 实现 URL 去重机制 (基于 URI 字段)
- [ ] 优化爬取配置 (从设置系统读取延迟、并发等)

#### 验收标准:
- 支持单个和批量 URL 抓取
- 集成现有反爬虫机制 (User-Agent、延迟等)
- 抓取任务能异步执行并跟踪进度
- 抓取内容能正确向量化存储

---

### 11. 文档块管理系统 (P2-2)
**预估时间**: 3-4天  
**依赖**: P1-1 文件导入功能  
**描述**: 基于 SQLAlchemy 实现精细的文档块管理

#### 实现任务:
- [ ] 创建 DocumentChunk 模型 (SQLAlchemy)
- [ ] 创建 DocumentChunk Repository (CRUD 操作)
- [ ] 实现文档块与 ChromaDB 向量的精确映射
- [ ] 实现块级别状态管理 (pending, indexed, failed)
- [ ] 实现块内容预览和查询功能
- [ ] 实现块级别的删除和重建操作
- [ ] 集成到现有文件导入流程

#### 验收标准:
- 文档切分后的每个块都有数据库记录
- 块与 ChromaDB 向量 ID 正确映射
- 支持块级别的状态跟踪和管理
- 能提供块内容预览和来源追溯

---

### 12. 任务日志系统 (P2-3)
**预估时间**: 2-3天  
**依赖**: P1-2 任务系统  
**描述**: 基于 SQLAlchemy 实现详细任务日志

#### 实现任务:
- [ ] 创建 TaskLog 模型 (SQLAlchemy)
- [ ] 创建 TaskLog Repository (CRUD 操作)
- [ ] 实现日志级别管理 (debug, info, warning, error)
- [ ] 实现日志查询和过滤 API
- [ ] 实现日志自动清理机制 (定时任务)
- [ ] 集成日志到 SSE 流推送
- [ ] 实现日志统计和分析功能

#### 验收标准:
- 任务执行过程生成详细日志记录
- 支持按级别、时间、任务 ID 过滤日志
- 日志能通过 SSE 实时推送给前端
- 支持历史日志查询和统计分析

---

### 13. 高级检索功能 (P2-4)
**预估时间**: 4-5天  
**依赖**: P1-3 基础问答功能  
**描述**: 扩展现有 RAG 实现，支持混合检索策略

#### 实现任务:
- [ ] 集成现有 retrieval_strategies.py 实现 BM25 检索
- [ ] 实现混合检索 (语义 + 关键词)：
  - 扩展现有 RetrievalChain 支持多策略
  - 实现检索结果融合和重排序
- [ ] 集成现有 cache_manager.py 实现检索缓存
- [ ] 实现上下文窗口管理和优化
- [ ] 集成现有 intent_analyzer.py 进行查询分析
- [ ] 实现查询扩展和改写功能

#### 验收标准:
- 支持语义 + BM25 混合检索
- 检索结果质量和相关性提升
- 查询响应速度优化 (缓存命中)
- 支持复杂查询意图分析和处理

---

### 14. 系统监控和管理 (P2-5)
**预估时间**: 3-4天  
**依赖**: 所有核心功能  
**描述**: 实现系统监控、性能统计和健康管理

#### 实现任务:
- [ ] 扩展健康检查端点，增加详细状态:
  - 数据库连接状态
  - ChromaDB 连接状态
  - OpenAI API 可用性
  - 磁盘空间和内存使用
- [ ] 实现资源使用统计:
  - 知识库/文档数量统计
  - 向量数据存储统计
  - API 调用频率统计
- [ ] 实现性能监控:
  - 查询响应时间监控
  - 文件导入处理时间统计
  - 错误率和成功率跟踪
- [ ] 实现系统配置和诊断 API
- [ ] 实现错误报告和告警机制

#### 验收标准:
- 健康检查能全面反映系统状态
- 资源使用情况能清晰展示
- 性能指标能准确统计和监控
- 能及时发现和报告系统问题

---

## 技术依赖清单

### 新增 Python 依赖
```bash
# 数据库相关
sqlalchemy>=2.0.0
alembic>=1.13.0

# 异步 SSE 支持  
sse-starlette>=1.6.0
```

### 现有技术组件重用
- ✅ **ChromaDB**: `backend/vector_store/chroma_client.py` (ChromaManager)
- ✅ **RAG**: `backend/rag/retrieval_chain.py` (RetrievalChain)
- ✅ **爬虫**: `backend/crawler/simple_web_crawler.py` (SimpleWebCrawler)
- ✅ **文件处理**: `backend/data_processing/file_processor.py`
- ✅ **文本切分**: `backend/data_processing/text_splitter.py`
- ✅ **配置管理**: `backend/config.py`
- ✅ **FastAPI**: 现有 API 路由结构

---

## 实施建议

### 开发顺序
1. **第一阶段** (1-2周): 完成 P0 所有任务，建立 SQLAlchemy 数据库基础和统一 API
2. **第二阶段** (2-3周): 完成 P1 任务，实现文件导入、任务系统和问答功能
3. **第三阶段** (1-2周): 根据需求选择性实现 P2 高级功能

### 开发优先级调整建议
- **如果前端急需问答功能**: 可以先实现 P1-3 (基础问答)，基于现有 RetrievalChain
- **如果急需文件导入**: P1-1 和 P1-2 优先级可以提升
- **URL 抓取不急**: P2-1 可以延后，现有爬虫已经比较完善

### 测试策略
- **单元测试**: 重点测试 SQLAlchemy 模型、Repository 类、业务逻辑
- **集成测试**: 测试 API 端点、数据库事务、ChromaDB 集成
- **现有组件**: 重用现有的文件处理、RAG 等组件的测试

### 部署和迁移
- **数据库迁移**: 使用 Alembic 管理 SQLAlchemy 迁移
- **现有数据**: 需要考虑现有 ChromaDB 数据的兼容性
- **配置兼容**: 保持与现有 config.py 的兼容性

### 风险和注意事项
1. **现有 ChromaDB 数据**: 需要确保新的数据库设计与现有 ChromaDB collection 数据兼容
2. **API 接口变更**: 现有前端可能需要适配新的 API 响应格式
3. **异步任务**: 需要合理设计任务队列，避免内存泄漏和资源占用
4. **数据一致性**: SQLAlchemy 数据库与 ChromaDB 之间的数据同步需要仔细处理

---

## 开发检查清单

### P0 阶段完成标志
- [x] SQLAlchemy 模型定义完整 ✅ **已完成 (P0-1)**
- [ ] 统一 API 响应格式生效  
- [ ] 知识库 CRUD 功能正常
- [ ] 文档管理基础功能可用
- [ ] 设置管理集成现有配置

### P1 阶段完成标志
- [ ] 文件导入异步任务可用
- [ ] 任务进度 SSE 推送正常
- [ ] 基于多知识库的问答可用
- [ ] 对话管理功能完整

### P2 阶段完成标志
- [ ] URL 抓取功能集成现有爬虫
- [ ] 文档块精细管理可用
- [ ] 任务日志详细记录
- [ ] 混合检索策略提升效果
- [ ] 系统监控全面覆盖

---

**重要提醒**: 此文档基于当前技术栈 (SQLAlchemy + 现有 ChromaDB/RAG/爬虫组件) 制定。实施时应充分重用现有代码，避免重复开发。每个任务完成后都应更新相应的 API 文档和数据库设计文档。